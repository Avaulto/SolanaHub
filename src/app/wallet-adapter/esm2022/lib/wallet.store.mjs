import { Inject, Injectable, InjectionToken } from '@angular/core';
import { ComponentStore } from '@ngrx/component-store';
import { WalletNotConnectedError, WalletNotReadyError, WalletReadyState, } from '@solana/wallet-adapter-base';
import { EMPTY, catchError, combineLatest, concatMap, defer, filter, finalize, first, firstValueFrom, from, fromEvent, merge, of, pairwise, switchMap, tap, throwError, withLatestFrom, } from 'rxjs';
import { LocalStorageSubject, WalletNotSelectedError, fromAdapterEvent, handleEvent, signAllTransactions, signMessage, signTransaction, } from './internals';
import * as i0 from "@angular/core";
export const WALLET_CONFIG = new InjectionToken('walletConfig');
export const walletConfigProviderFactory = (config) => ({
    provide: WALLET_CONFIG,
    useValue: {
        autoConnect: false,
        localStorageKey: 'walletName',
        adapters: [],
        ...config,
    },
});
const initialState = {
    wallet: null,
    adapter: null,
    connected: false,
    publicKey: null,
    readyState: null,
};
export class WalletStore extends ComponentStore {
    constructor(_config) {
        super({
            ...initialState,
            wallets: [],
            adapters: [],
            connecting: false,
            disconnecting: false,
            unloading: false,
            autoConnect: _config.autoConnect || false,
            readyState: null,
            error: null,
        });
        this._config = _config;
        this._name = new LocalStorageSubject(this._config.localStorageKey);
        this._unloading$ = this.select(({ unloading }) => unloading);
        this._adapters$ = this.select(({ adapters }) => adapters);
        this._adapter$ = this.select(({ adapter }) => adapter);
        this._name$ = this._name.asObservable();
        this._readyState$ = this.select(({ readyState }) => readyState);
        this.wallets$ = this.select(({ wallets }) => wallets);
        this.autoConnect$ = this.select(({ autoConnect }) => autoConnect);
        this.wallet$ = this.select(({ wallet }) => wallet);
        this.publicKey$ = this.select(({ publicKey }) => publicKey);
        this.connecting$ = this.select(({ connecting }) => connecting);
        this.disconnecting$ = this.select(({ disconnecting }) => disconnecting);
        this.connected$ = this.select(({ connected }) => connected);
        this.error$ = this.select(({ error }) => error);
        this.anchorWallet$ = this.select(this.publicKey$, this._adapter$, this.connected$, (publicKey, adapter, connected) => {
            return publicKey &&
                adapter &&
                'signTransaction' in adapter &&
                'signAllTransactions' in adapter
                ? {
                    publicKey,
                    signTransaction: (transaction) => firstValueFrom(signTransaction(adapter, connected, (error) => this._setError(error))(transaction)),
                    signAllTransactions: (transactions) => firstValueFrom(signAllTransactions(adapter, connected, (error) => this._setError(error))(transactions)),
                }
                : undefined;
        }, { debounce: true });
        // Set error
        this._setError = this.updater((state, error) => ({
            ...state,
            error: state.unloading ? state.error : error,
        }));
        // Set ready state
        this._setReadyState = this.updater((state, { readyState, walletName, }) => ({
            ...state,
            wallets: state.wallets.map((wallet) => wallet.adapter.name === walletName ? { ...wallet, readyState } : wallet),
            readyState: state.adapter?.name === walletName ? readyState : state.readyState,
        }));
        // Set adapters
        this.setAdapters = this.updater((state, adapters) => ({
            ...state,
            adapters,
            wallets: adapters.map((adapter) => ({
                adapter,
                readyState: adapter.readyState,
            })),
        }));
        // Update ready state for newly selected adapter
        this.onAdapterChangeDisconnectPreviousAdapter = this.effect(() => this._adapter$.pipe(pairwise(), concatMap(([adapter]) => adapter && adapter.connected
            ? from(defer(() => adapter.disconnect()))
            : of(null))));
        // When the selected wallet changes, initialize the state
        this.onWalletChanged = this.effect(() => combineLatest([this._name$, this.wallets$]).pipe(tap(([name, wallets]) => {
            const wallet = wallets.find(({ adapter }) => adapter.name === name);
            if (wallet) {
                this.patchState({
                    wallet,
                    adapter: wallet.adapter,
                    connected: wallet.adapter.connected,
                    publicKey: wallet.adapter.publicKey,
                    readyState: wallet.adapter.readyState,
                });
            }
            else {
                this.patchState(initialState);
            }
        })));
        // If autoConnect is enabled, try to connect when the adapter changes and is ready
        this.onAutoConnect = this.effect(() => {
            return combineLatest([
                this._adapter$,
                this._readyState$,
                this.autoConnect$,
                this.connecting$,
                this.connected$,
            ]).pipe(concatMap(([adapter, readyState, autoConnect, connecting, connected]) => {
                if (!autoConnect ||
                    adapter == null ||
                    (readyState !== WalletReadyState.Installed &&
                        readyState !== WalletReadyState.Loadable) ||
                    connecting ||
                    connected) {
                    return EMPTY;
                }
                this.patchState({ connecting: true });
                return from(defer(() => adapter.connect())).pipe(catchError(() => {
                    // Clear the selected wallet
                    this.selectWallet(null);
                    // Don't throw error, but onError will still be called
                    return EMPTY;
                }), finalize(() => this.patchState({ connecting: false })));
            }));
        });
        // If the window is closing or reloading, ignore disconnect and error events from the adapter
        this.onWindowUnload = this.effect(() => {
            if (typeof window === 'undefined') {
                return of(null);
            }
            return fromEvent(window, 'beforeunload').pipe(tap(() => this.patchState({ unloading: true })));
        });
        // Handle the adapter's connect event
        this.onConnect = this.effect(() => {
            return this._adapter$.pipe(handleEvent((adapter) => fromAdapterEvent(adapter, 'connect').pipe(tap(() => this.patchState({
                connected: adapter.connected,
                publicKey: adapter.publicKey,
            })))));
        });
        // Handle the adapter's disconnect event
        this.onDisconnect = this.effect(() => {
            return this._adapter$.pipe(handleEvent((adapter) => fromAdapterEvent(adapter, 'disconnect').pipe(concatMap(() => of(null).pipe(withLatestFrom(this._unloading$))), filter(([, unloading]) => !unloading), tap(() => this.selectWallet(null)))));
        });
        // Handle the adapter's error event
        this.onError = this.effect(() => {
            return this._adapter$.pipe(handleEvent((adapter) => fromAdapterEvent(adapter, 'error').pipe(tap((error) => this._setError(error)))));
        });
        // Handle all adapters ready state change events
        this.onReadyStateChanges = this.effect(() => {
            return this._adapters$.pipe(switchMap((adapters) => merge(...adapters.map((adapter) => fromAdapterEvent(adapter, 'readyStateChange').pipe(tap((readyState) => this._setReadyState({ readyState, walletName: adapter.name })))))));
        });
        this.setAdapters(this._config.adapters);
    }
    // Select a new wallet
    selectWallet(walletName) {
        this._name.next(walletName);
    }
    // Connect the adapter to the wallet
    connect() {
        return combineLatest([
            this.connecting$,
            this.disconnecting$,
            this.connected$,
            this._adapter$,
            this._readyState$,
        ]).pipe(first(), filter(([connecting, disconnecting, connected]) => !connected && !connecting && !disconnecting), concatMap(([, , , adapter, readyState]) => {
            if (!adapter) {
                const error = new WalletNotSelectedError();
                this._setError(error);
                return throwError(() => error);
            }
            if (!(readyState === WalletReadyState.Installed ||
                readyState === WalletReadyState.Loadable)) {
                this.selectWallet(null);
                if (typeof window !== 'undefined') {
                    window.open(adapter.url, '_blank');
                }
                const error = new WalletNotReadyError();
                this._setError(error);
                return throwError(() => error);
            }
            this.patchState({ connecting: true });
            return from(defer(() => adapter.connect())).pipe(catchError((error) => {
                this.selectWallet(null);
                return throwError(() => error);
            }), finalize(() => this.patchState({ connecting: false })));
        }));
    }
    // Disconnect the adapter from the wallet
    disconnect() {
        return combineLatest([this.disconnecting$, this._adapter$]).pipe(first(), filter(([disconnecting]) => !disconnecting), concatMap(([, adapter]) => {
            if (!adapter) {
                this.selectWallet(null);
                return EMPTY;
            }
            this.patchState({ disconnecting: true });
            return from(defer(() => adapter.disconnect())).pipe(catchError((error) => {
                this.selectWallet(null);
                // Rethrow the error, and handleError will also be called
                return throwError(() => error);
            }), finalize(() => {
                this.patchState({ disconnecting: false });
            }));
        }));
    }
    // Send a transaction using the provided connection
    sendTransaction(transaction, connection, options) {
        return combineLatest([this._adapter$, this.connected$]).pipe(first(), concatMap(([adapter, connected]) => {
            if (!adapter) {
                const error = new WalletNotSelectedError();
                this._setError(error);
                return throwError(() => error);
            }
            if (!connected) {
                const error = new WalletNotConnectedError();
                this._setError(error);
                return throwError(() => error);
            }
            return from(defer(() => adapter.sendTransaction(transaction, connection, options)));
        }));
    }
    // Sign a transaction if the wallet supports it
    signTransaction(transaction) {
        const { adapter, connected } = this.get();
        return adapter && 'signTransaction' in adapter
            ? signTransaction(adapter, connected, (error) => this._setError(error))(transaction)
            : undefined;
    }
    // Sign multiple transactions if the wallet supports it
    signAllTransactions(transactions) {
        const { adapter, connected } = this.get();
        return adapter && 'signAllTransactions' in adapter
            ? signAllTransactions(adapter, connected, (error) => this._setError(error))(transactions)
            : undefined;
    }
    // Sign an arbitrary message if the wallet supports it
    signMessage(message) {
        const { adapter, connected } = this.get();
        return adapter && 'signMessage' in adapter
            ? signMessage(adapter, connected, (error) => this._setError(error))(message)
            : undefined;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.2", ngImport: i0, type: WalletStore, deps: [{ token: WALLET_CONFIG }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.2", ngImport: i0, type: WalletStore }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.2", ngImport: i0, type: WalletStore, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [WALLET_CONFIG]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2FsbGV0LnN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvZGF0YS1hY2Nlc3Mvc3JjL2xpYi93YWxsZXQuc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25FLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN2RCxPQUFPLEVBS0wsdUJBQXVCLEVBQ3ZCLG1CQUFtQixFQUNuQixnQkFBZ0IsR0FDakIsTUFBTSw2QkFBNkIsQ0FBQztBQVFyQyxPQUFPLEVBQ0wsS0FBSyxFQUVMLFVBQVUsRUFDVixhQUFhLEVBQ2IsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBQ04sUUFBUSxFQUNSLEtBQUssRUFDTCxjQUFjLEVBQ2QsSUFBSSxFQUNKLFNBQVMsRUFDVCxLQUFLLEVBQ0wsRUFBRSxFQUNGLFFBQVEsRUFDUixTQUFTLEVBQ1QsR0FBRyxFQUNILFVBQVUsRUFDVixjQUFjLEdBQ2YsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQ0wsbUJBQW1CLEVBRW5CLHNCQUFzQixFQUN0QixnQkFBZ0IsRUFDaEIsV0FBVyxFQUNYLG1CQUFtQixFQUNuQixXQUFXLEVBQ1gsZUFBZSxHQUNoQixNQUFNLGFBQWEsQ0FBQzs7QUF1QnJCLE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxJQUFJLGNBQWMsQ0FBZSxjQUFjLENBQUMsQ0FBQztBQUU5RSxNQUFNLENBQUMsTUFBTSwyQkFBMkIsR0FBRyxDQUFDLE1BQTZCLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDN0UsT0FBTyxFQUFFLGFBQWE7SUFDdEIsUUFBUSxFQUFFO1FBQ1IsV0FBVyxFQUFFLEtBQUs7UUFDbEIsZUFBZSxFQUFFLFlBQVk7UUFDN0IsUUFBUSxFQUFFLEVBQUU7UUFDWixHQUFHLE1BQU07S0FDVjtDQUNG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cnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb21wb25lbnRTdG9yZSB9IGZyb20gJ0BuZ3J4L2NvbXBvbmVudC1zdG9yZSc7XG5pbXBvcnQge1xuICBBZGFwdGVyLFxuICBTZW5kVHJhbnNhY3Rpb25PcHRpb25zLFxuICBXYWxsZXRFcnJvcixcbiAgV2FsbGV0TmFtZSxcbiAgV2FsbGV0Tm90Q29ubmVjdGVkRXJyb3IsXG4gIFdhbGxldE5vdFJlYWR5RXJyb3IsXG4gIFdhbGxldFJlYWR5U3RhdGUsXG59IGZyb20gJ0Bzb2xhbmEvd2FsbGV0LWFkYXB0ZXItYmFzZSc7XG5pbXBvcnQge1xuICBDb25uZWN0aW9uLFxuICBQdWJsaWNLZXksXG4gIFRyYW5zYWN0aW9uLFxuICBUcmFuc2FjdGlvblNpZ25hdHVyZSxcbiAgVmVyc2lvbmVkVHJhbnNhY3Rpb24sXG59IGZyb20gJ0Bzb2xhbmEvd2ViMy5qcyc7XG5pbXBvcnQge1xuICBFTVBUWSxcbiAgT2JzZXJ2YWJsZSxcbiAgY2F0Y2hFcnJvcixcbiAgY29tYmluZUxhdGVzdCxcbiAgY29uY2F0TWFwLFxuICBkZWZlcixcbiAgZmlsdGVyLFxuICBmaW5hbGl6ZSxcbiAgZmlyc3QsXG4gIGZpcnN0VmFsdWVGcm9tLFxuICBmcm9tLFxuICBmcm9tRXZlbnQsXG4gIG1lcmdlLFxuICBvZixcbiAgcGFpcndpc2UsXG4gIHN3aXRjaE1hcCxcbiAgdGFwLFxuICB0aHJvd0Vycm9yLFxuICB3aXRoTGF0ZXN0RnJvbSxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBMb2NhbFN0b3JhZ2VTdWJqZWN0LFxuICBTaWduZXJXYWxsZXRBZGFwdGVyUHJvcHMsXG4gIFdhbGxldE5vdFNlbGVjdGVkRXJyb3IsXG4gIGZyb21BZGFwdGVyRXZlbnQsXG4gIGhhbmRsZUV2ZW50LFxuICBzaWduQWxsVHJhbnNhY3Rpb25zLFxuICBzaWduTWVzc2FnZSxcbiAgc2lnblRyYW5zYWN0aW9uLFxufSBmcm9tICcuL2ludGVybmFscyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2FsbGV0IHtcbiAgYWRhcHRlcjogQWRhcHRlcjtcbiAgcmVhZHlTdGF0ZTogV2FsbGV0UmVhZHlTdGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBbmNob3JXYWxsZXQge1xuICBwdWJsaWNLZXk6IFB1YmxpY0tleTtcbiAgc2lnblRyYW5zYWN0aW9uPFQgZXh0ZW5kcyBUcmFuc2FjdGlvbiB8IFZlcnNpb25lZFRyYW5zYWN0aW9uPihcbiAgICB0cmFuc2FjdGlvbjogVFxuICApOiBQcm9taXNlPFQ+O1xuICBzaWduQWxsVHJhbnNhY3Rpb25zPFQgZXh0ZW5kcyBUcmFuc2FjdGlvbiB8IFZlcnNpb25lZFRyYW5zYWN0aW9uPihcbiAgICB0cmFuc2FjdGlvbnM6IFRbXVxuICApOiBQcm9taXNlPFRbXT47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2FsbGV0Q29uZmlnIHtcbiAgbG9jYWxTdG9yYWdlS2V5OiBzdHJpbmc7XG4gIGF1dG9Db25uZWN0OiBib29sZWFuO1xuICBhZGFwdGVyczogQWRhcHRlcltdO1xufVxuXG5leHBvcnQgY29uc3QgV0FMTEVUX0NPTkZJRyA9IG5ldyBJbmplY3Rpb25Ub2tlbjxXYWxsZXRDb25maWc+KCd3YWxsZXRDb25maWcnKTtcblxuZXhwb3J0IGNvbnN0IHdhbGxldENvbmZpZ1Byb3ZpZGVyRmFjdG9yeSA9IChjb25maWc6IFBhcnRpYWw8V2FsbGV0Q29uZmlnPikgPT4gKHtcbiAgcHJvdmlkZTogV0FMTEVUX0NPTkZJRyxcbiAgdXNlVmFsdWU6IHtcbiAgICBhdXRvQ29ubmVjdDogZmFsc2UsXG4gICAgbG9jYWxTdG9yYWdlS2V5OiAnd2FsbGV0TmFtZScsXG4gICAgYWRhcHRlcnM6IFtdLFxuICAgIC4uLmNvbmZpZyxcbiAgfSxcbn0pO1xuXG5pbnRlcmZhY2UgV2FsbGV0U3RhdGUge1xuICBhZGFwdGVyczogQWRhcHRlcltdO1xuICB3YWxsZXRzOiBXYWxsZXRbXTtcbiAgd2FsbGV0OiBXYWxsZXQgfCBudWxsO1xuICBhZGFwdGVyOiBBZGFwdGVyIHwgbnVsbDtcbiAgY29ubmVjdGluZzogYm9vbGVhbjtcbiAgZGlzY29ubmVjdGluZzogYm9vbGVhbjtcbiAgdW5sb2FkaW5nOiBib29sZWFuO1xuICBjb25uZWN0ZWQ6IGJvb2xlYW47XG4gIHJlYWR5U3RhdGU6IFdhbGxldFJlYWR5U3RhdGUgfCBudWxsO1xuICBwdWJsaWNLZXk6IFB1YmxpY0tleSB8IG51bGw7XG4gIGF1dG9Db25uZWN0OiBib29sZWFuO1xuICBlcnJvcjogV2FsbGV0RXJyb3IgfCBudWxsO1xufVxuXG5jb25zdCBpbml0aWFsU3RhdGU6IHtcbiAgd2FsbGV0OiBXYWxsZXQgfCBudWxsO1xuICBhZGFwdGVyOiBBZGFwdGVyIHwgbnVsbDtcbiAgY29ubmVjdGVkOiBib29sZWFuO1xuICBwdWJsaWNLZXk6IFB1YmxpY0tleSB8IG51bGw7XG4gIHJlYWR5U3RhdGU6IFdhbGxldFJlYWR5U3RhdGUgfCBudWxsO1xufSA9IHtcbiAgd2FsbGV0OiBudWxsLFxuICBhZGFwdGVyOiBudWxsLFxuICBjb25uZWN0ZWQ6IGZhbHNlLFxuICBwdWJsaWNLZXk6IG51bGwsXG4gIHJlYWR5U3RhdGU6IG51bGwsXG59O1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgV2FsbGV0U3RvcmUgZXh0ZW5kcyBDb21wb25lbnRTdG9yZTxXYWxsZXRTdGF0ZT4ge1xuICBwcml2YXRlIHJlYWRvbmx5IF9uYW1lID0gbmV3IExvY2FsU3RvcmFnZVN1YmplY3Q8V2FsbGV0TmFtZT4oXG4gICAgdGhpcy5fY29uZmlnLmxvY2FsU3RvcmFnZUtleVxuICApO1xuICBwcml2YXRlIHJlYWRvbmx5IF91bmxvYWRpbmckID0gdGhpcy5zZWxlY3QoKHsgdW5sb2FkaW5nIH0pID0+IHVubG9hZGluZyk7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2FkYXB0ZXJzJCA9IHRoaXMuc2VsZWN0KCh7IGFkYXB0ZXJzIH0pID0+IGFkYXB0ZXJzKTtcbiAgcHJpdmF0ZSByZWFkb25seSBfYWRhcHRlciQgPSB0aGlzLnNlbGVjdCgoeyBhZGFwdGVyIH0pID0+IGFkYXB0ZXIpO1xuICBwcml2YXRlIHJlYWRvbmx5IF9uYW1lJCA9IHRoaXMuX25hbWUuYXNPYnNlcnZhYmxlKCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlYWR5U3RhdGUkID0gdGhpcy5zZWxlY3QoKHsgcmVhZHlTdGF0ZSB9KSA9PiByZWFkeVN0YXRlKTtcbiAgcmVhZG9ubHkgd2FsbGV0cyQgPSB0aGlzLnNlbGVjdCgoeyB3YWxsZXRzIH0pID0+IHdhbGxldHMpO1xuICByZWFkb25seSBhdXRvQ29ubmVjdCQgPSB0aGlzLnNlbGVjdCgoeyBhdXRvQ29ubmVjdCB9KSA9PiBhdXRvQ29ubmVjdCk7XG4gIHJlYWRvbmx5IHdhbGxldCQgPSB0aGlzLnNlbGVjdCgoeyB3YWxsZXQgfSkgPT4gd2FsbGV0KTtcbiAgcmVhZG9ubHkgcHVibGljS2V5JCA9IHRoaXMuc2VsZWN0KCh7IHB1YmxpY0tleSB9KSA9PiBwdWJsaWNLZXkpO1xuICByZWFkb25seSBjb25uZWN0aW5nJCA9IHRoaXMuc2VsZWN0KCh7IGNvbm5lY3RpbmcgfSkgPT4gY29ubmVjdGluZyk7XG4gIHJlYWRvbmx5IGRpc2Nvbm5lY3RpbmckID0gdGhpcy5zZWxlY3QoKHsgZGlzY29ubmVjdGluZyB9KSA9PiBkaXNjb25uZWN0aW5nKTtcbiAgcmVhZG9ubHkgY29ubmVjdGVkJCA9IHRoaXMuc2VsZWN0KCh7IGNvbm5lY3RlZCB9KSA9PiBjb25uZWN0ZWQpO1xuICByZWFkb25seSBlcnJvciQgPSB0aGlzLnNlbGVjdCgoeyBlcnJvciB9KSA9PiBlcnJvcik7XG4gIHJlYWRvbmx5IGFuY2hvcldhbGxldCQgPSB0aGlzLnNlbGVjdChcbiAgICB0aGlzLnB1YmxpY0tleSQsXG4gICAgdGhpcy5fYWRhcHRlciQsXG4gICAgdGhpcy5jb25uZWN0ZWQkLFxuICAgIChwdWJsaWNLZXksIGFkYXB0ZXIsIGNvbm5lY3RlZCkgPT4ge1xuICAgICAgcmV0dXJuIHB1YmxpY0tleSAmJlxuICAgICAgICBhZGFwdGVyICYmXG4gICAgICAgICdzaWduVHJhbnNhY3Rpb24nIGluIGFkYXB0ZXIgJiZcbiAgICAgICAgJ3NpZ25BbGxUcmFuc2FjdGlvbnMnIGluIGFkYXB0ZXJcbiAgICAgICAgPyAoe1xuICAgICAgICAgICAgcHVibGljS2V5LFxuICAgICAgICAgICAgc2lnblRyYW5zYWN0aW9uOiA8VCBleHRlbmRzIFRyYW5zYWN0aW9uIHwgVmVyc2lvbmVkVHJhbnNhY3Rpb24+KFxuICAgICAgICAgICAgICB0cmFuc2FjdGlvbjogVFxuICAgICAgICAgICAgKTogUHJvbWlzZTxUPiA9PlxuICAgICAgICAgICAgICBmaXJzdFZhbHVlRnJvbShcbiAgICAgICAgICAgICAgICBzaWduVHJhbnNhY3Rpb248VD4oYWRhcHRlciwgY29ubmVjdGVkLCAoZXJyb3IpID0+XG4gICAgICAgICAgICAgICAgICB0aGlzLl9zZXRFcnJvcihlcnJvcilcbiAgICAgICAgICAgICAgICApKHRyYW5zYWN0aW9uKVxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgc2lnbkFsbFRyYW5zYWN0aW9uczogPFQgZXh0ZW5kcyBUcmFuc2FjdGlvbiB8IFZlcnNpb25lZFRyYW5zYWN0aW9uPihcbiAgICAgICAgICAgICAgdHJhbnNhY3Rpb25zOiBUW11cbiAgICAgICAgICAgICk6IFByb21pc2U8VFtdPiA9PlxuICAgICAgICAgICAgICBmaXJzdFZhbHVlRnJvbShcbiAgICAgICAgICAgICAgICBzaWduQWxsVHJhbnNhY3Rpb25zPFQ+KGFkYXB0ZXIsIGNvbm5lY3RlZCwgKGVycm9yKSA9PlxuICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0RXJyb3IoZXJyb3IpXG4gICAgICAgICAgICAgICAgKSh0cmFuc2FjdGlvbnMpXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgfSBhcyBBbmNob3JXYWxsZXQpXG4gICAgICAgIDogdW5kZWZpbmVkO1xuICAgIH0sXG4gICAgeyBkZWJvdW5jZTogdHJ1ZSB9XG4gICk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChXQUxMRVRfQ09ORklHKVxuICAgIHByaXZhdGUgX2NvbmZpZzogV2FsbGV0Q29uZmlnXG4gICkge1xuICAgIHN1cGVyKHtcbiAgICAgIC4uLmluaXRpYWxTdGF0ZSxcbiAgICAgIHdhbGxldHM6IFtdLFxuICAgICAgYWRhcHRlcnM6IFtdLFxuICAgICAgY29ubmVjdGluZzogZmFsc2UsXG4gICAgICBkaXNjb25uZWN0aW5nOiBmYWxzZSxcbiAgICAgIHVubG9hZGluZzogZmFsc2UsXG4gICAgICBhdXRvQ29ubmVjdDogX2NvbmZpZy5hdXRvQ29ubmVjdCB8fCBmYWxzZSxcbiAgICAgIHJlYWR5U3RhdGU6IG51bGwsXG4gICAgICBlcnJvcjogbnVsbCxcbiAgICB9KTtcblxuICAgIHRoaXMuc2V0QWRhcHRlcnModGhpcy5fY29uZmlnLmFkYXB0ZXJzKTtcbiAgfVxuXG4gIC8vIFNldCBlcnJvclxuICBwcml2YXRlIHJlYWRvbmx5IF9zZXRFcnJvciA9IHRoaXMudXBkYXRlcigoc3RhdGUsIGVycm9yOiBXYWxsZXRFcnJvcikgPT4gKHtcbiAgICAuLi5zdGF0ZSxcbiAgICBlcnJvcjogc3RhdGUudW5sb2FkaW5nID8gc3RhdGUuZXJyb3IgOiBlcnJvcixcbiAgfSkpO1xuXG4gIC8vIFNldCByZWFkeSBzdGF0ZVxuICBwcml2YXRlIHJlYWRvbmx5IF9zZXRSZWFkeVN0YXRlID0gdGhpcy51cGRhdGVyKFxuICAgIChcbiAgICAgIHN0YXRlLFxuICAgICAge1xuICAgICAgICByZWFkeVN0YXRlLFxuICAgICAgICB3YWxsZXROYW1lLFxuICAgICAgfTogeyByZWFkeVN0YXRlOiBXYWxsZXRSZWFkeVN0YXRlOyB3YWxsZXROYW1lOiBXYWxsZXROYW1lIH1cbiAgICApID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIHdhbGxldHM6IHN0YXRlLndhbGxldHMubWFwKCh3YWxsZXQpID0+XG4gICAgICAgIHdhbGxldC5hZGFwdGVyLm5hbWUgPT09IHdhbGxldE5hbWUgPyB7IC4uLndhbGxldCwgcmVhZHlTdGF0ZSB9IDogd2FsbGV0XG4gICAgICApLFxuICAgICAgcmVhZHlTdGF0ZTpcbiAgICAgICAgc3RhdGUuYWRhcHRlcj8ubmFtZSA9PT0gd2FsbGV0TmFtZSA/IHJlYWR5U3RhdGUgOiBzdGF0ZS5yZWFkeVN0YXRlLFxuICAgIH0pXG4gICk7XG5cbiAgLy8gU2V0IGFkYXB0ZXJzXG4gIHJlYWRvbmx5IHNldEFkYXB0ZXJzID0gdGhpcy51cGRhdGVyKChzdGF0ZSwgYWRhcHRlcnM6IEFkYXB0ZXJbXSkgPT4gKHtcbiAgICAuLi5zdGF0ZSxcbiAgICBhZGFwdGVycyxcbiAgICB3YWxsZXRzOiBhZGFwdGVycy5tYXAoKGFkYXB0ZXIpID0+ICh7XG4gICAgICBhZGFwdGVyLFxuICAgICAgcmVhZHlTdGF0ZTogYWRhcHRlci5yZWFkeVN0YXRlLFxuICAgIH0pKSxcbiAgfSkpO1xuXG4gIC8vIFVwZGF0ZSByZWFkeSBzdGF0ZSBmb3IgbmV3bHkgc2VsZWN0ZWQgYWRhcHRlclxuICByZWFkb25seSBvbkFkYXB0ZXJDaGFuZ2VEaXNjb25uZWN0UHJldmlvdXNBZGFwdGVyID0gdGhpcy5lZmZlY3QoKCkgPT5cbiAgICB0aGlzLl9hZGFwdGVyJC5waXBlKFxuICAgICAgcGFpcndpc2UoKSxcbiAgICAgIGNvbmNhdE1hcCgoW2FkYXB0ZXJdKSA9PlxuICAgICAgICBhZGFwdGVyICYmIGFkYXB0ZXIuY29ubmVjdGVkXG4gICAgICAgICAgPyBmcm9tKGRlZmVyKCgpID0+IGFkYXB0ZXIuZGlzY29ubmVjdCgpKSlcbiAgICAgICAgICA6IG9mKG51bGwpXG4gICAgICApXG4gICAgKVxuICApO1xuXG4gIC8vIFdoZW4gdGhlIHNlbGVjdGVkIHdhbGxldCBjaGFuZ2VzLCBpbml0aWFsaXplIHRoZSBzdGF0ZVxuICByZWFkb25seSBvbldhbGxldENoYW5nZWQgPSB0aGlzLmVmZmVjdCgoKSA9PlxuICAgIGNvbWJpbmVMYXRlc3QoW3RoaXMuX25hbWUkLCB0aGlzLndhbGxldHMkXSkucGlwZShcbiAgICAgIHRhcCgoW25hbWUsIHdhbGxldHNdKSA9PiB7XG4gICAgICAgIGNvbnN0IHdhbGxldCA9IHdhbGxldHMuZmluZCgoeyBhZGFwdGVyIH0pID0+IGFkYXB0ZXIubmFtZSA9PT0gbmFtZSk7XG5cbiAgICAgICAgaWYgKHdhbGxldCkge1xuICAgICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7XG4gICAgICAgICAgICB3YWxsZXQsXG4gICAgICAgICAgICBhZGFwdGVyOiB3YWxsZXQuYWRhcHRlcixcbiAgICAgICAgICAgIGNvbm5lY3RlZDogd2FsbGV0LmFkYXB0ZXIuY29ubmVjdGVkLFxuICAgICAgICAgICAgcHVibGljS2V5OiB3YWxsZXQuYWRhcHRlci5wdWJsaWNLZXksXG4gICAgICAgICAgICByZWFkeVN0YXRlOiB3YWxsZXQuYWRhcHRlci5yZWFkeVN0YXRlLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMucGF0Y2hTdGF0ZShpbml0aWFsU3RhdGUpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgIClcbiAgKTtcblxuICAvLyBJZiBhdXRvQ29ubmVjdCBpcyBlbmFibGVkLCB0cnkgdG8gY29ubmVjdCB3aGVuIHRoZSBhZGFwdGVyIGNoYW5nZXMgYW5kIGlzIHJlYWR5XG4gIHJlYWRvbmx5IG9uQXV0b0Nvbm5lY3QgPSB0aGlzLmVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgdGhpcy5fYWRhcHRlciQsXG4gICAgICB0aGlzLl9yZWFkeVN0YXRlJCxcbiAgICAgIHRoaXMuYXV0b0Nvbm5lY3QkLFxuICAgICAgdGhpcy5jb25uZWN0aW5nJCxcbiAgICAgIHRoaXMuY29ubmVjdGVkJCxcbiAgICBdKS5waXBlKFxuICAgICAgY29uY2F0TWFwKChbYWRhcHRlciwgcmVhZHlTdGF0ZSwgYXV0b0Nvbm5lY3QsIGNvbm5lY3RpbmcsIGNvbm5lY3RlZF0pID0+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFhdXRvQ29ubmVjdCB8fFxuICAgICAgICAgIGFkYXB0ZXIgPT0gbnVsbCB8fFxuICAgICAgICAgIChyZWFkeVN0YXRlICE9PSBXYWxsZXRSZWFkeVN0YXRlLkluc3RhbGxlZCAmJlxuICAgICAgICAgICAgcmVhZHlTdGF0ZSAhPT0gV2FsbGV0UmVhZHlTdGF0ZS5Mb2FkYWJsZSkgfHxcbiAgICAgICAgICBjb25uZWN0aW5nIHx8XG4gICAgICAgICAgY29ubmVjdGVkXG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7IGNvbm5lY3Rpbmc6IHRydWUgfSk7XG4gICAgICAgIHJldHVybiBmcm9tKGRlZmVyKCgpID0+IGFkYXB0ZXIuY29ubmVjdCgpKSkucGlwZShcbiAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgICAgIC8vIENsZWFyIHRoZSBzZWxlY3RlZCB3YWxsZXRcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0V2FsbGV0KG51bGwpO1xuICAgICAgICAgICAgLy8gRG9uJ3QgdGhyb3cgZXJyb3IsIGJ1dCBvbkVycm9yIHdpbGwgc3RpbGwgYmUgY2FsbGVkXG4gICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5wYXRjaFN0YXRlKHsgY29ubmVjdGluZzogZmFsc2UgfSkpXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH0pO1xuXG4gIC8vIElmIHRoZSB3aW5kb3cgaXMgY2xvc2luZyBvciByZWxvYWRpbmcsIGlnbm9yZSBkaXNjb25uZWN0IGFuZCBlcnJvciBldmVudHMgZnJvbSB0aGUgYWRhcHRlclxuICByZWFkb25seSBvbldpbmRvd1VubG9hZCA9IHRoaXMuZWZmZWN0KCgpID0+IHtcbiAgICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZnJvbUV2ZW50KHdpbmRvdywgJ2JlZm9yZXVubG9hZCcpLnBpcGUoXG4gICAgICB0YXAoKCkgPT4gdGhpcy5wYXRjaFN0YXRlKHsgdW5sb2FkaW5nOiB0cnVlIH0pKVxuICAgICk7XG4gIH0pO1xuXG4gIC8vIEhhbmRsZSB0aGUgYWRhcHRlcidzIGNvbm5lY3QgZXZlbnRcbiAgcmVhZG9ubHkgb25Db25uZWN0ID0gdGhpcy5lZmZlY3QoKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9hZGFwdGVyJC5waXBlKFxuICAgICAgaGFuZGxlRXZlbnQoKGFkYXB0ZXIpID0+XG4gICAgICAgIGZyb21BZGFwdGVyRXZlbnQoYWRhcHRlciwgJ2Nvbm5lY3QnKS5waXBlKFxuICAgICAgICAgIHRhcCgoKSA9PlxuICAgICAgICAgICAgdGhpcy5wYXRjaFN0YXRlKHtcbiAgICAgICAgICAgICAgY29ubmVjdGVkOiBhZGFwdGVyLmNvbm5lY3RlZCxcbiAgICAgICAgICAgICAgcHVibGljS2V5OiBhZGFwdGVyLnB1YmxpY0tleSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgKTtcbiAgfSk7XG5cbiAgLy8gSGFuZGxlIHRoZSBhZGFwdGVyJ3MgZGlzY29ubmVjdCBldmVudFxuICByZWFkb25seSBvbkRpc2Nvbm5lY3QgPSB0aGlzLmVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX2FkYXB0ZXIkLnBpcGUoXG4gICAgICBoYW5kbGVFdmVudCgoYWRhcHRlcikgPT5cbiAgICAgICAgZnJvbUFkYXB0ZXJFdmVudChhZGFwdGVyLCAnZGlzY29ubmVjdCcpLnBpcGUoXG4gICAgICAgICAgY29uY2F0TWFwKCgpID0+IG9mKG51bGwpLnBpcGUod2l0aExhdGVzdEZyb20odGhpcy5fdW5sb2FkaW5nJCkpKSxcbiAgICAgICAgICBmaWx0ZXIoKFssIHVubG9hZGluZ10pID0+ICF1bmxvYWRpbmcpLFxuICAgICAgICAgIHRhcCgoKSA9PiB0aGlzLnNlbGVjdFdhbGxldChudWxsKSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gIH0pO1xuXG4gIC8vIEhhbmRsZSB0aGUgYWRhcHRlcidzIGVycm9yIGV2ZW50XG4gIHJlYWRvbmx5IG9uRXJyb3IgPSB0aGlzLmVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX2FkYXB0ZXIkLnBpcGUoXG4gICAgICBoYW5kbGVFdmVudCgoYWRhcHRlcikgPT5cbiAgICAgICAgZnJvbUFkYXB0ZXJFdmVudChhZGFwdGVyLCAnZXJyb3InKS5waXBlKFxuICAgICAgICAgIHRhcCgoZXJyb3IpID0+IHRoaXMuX3NldEVycm9yKGVycm9yKSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gIH0pO1xuXG4gIC8vIEhhbmRsZSBhbGwgYWRhcHRlcnMgcmVhZHkgc3RhdGUgY2hhbmdlIGV2ZW50c1xuICByZWFkb25seSBvblJlYWR5U3RhdGVDaGFuZ2VzID0gdGhpcy5lZmZlY3QoKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9hZGFwdGVycyQucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoYWRhcHRlcnMpID0+XG4gICAgICAgIG1lcmdlKFxuICAgICAgICAgIC4uLmFkYXB0ZXJzLm1hcCgoYWRhcHRlcikgPT5cbiAgICAgICAgICAgIGZyb21BZGFwdGVyRXZlbnQoYWRhcHRlciwgJ3JlYWR5U3RhdGVDaGFuZ2UnKS5waXBlKFxuICAgICAgICAgICAgICB0YXAoKHJlYWR5U3RhdGUpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5fc2V0UmVhZHlTdGF0ZSh7IHJlYWR5U3RhdGUsIHdhbGxldE5hbWU6IGFkYXB0ZXIubmFtZSB9KVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgKTtcbiAgfSk7XG5cbiAgLy8gU2VsZWN0IGEgbmV3IHdhbGxldFxuICBzZWxlY3RXYWxsZXQod2FsbGV0TmFtZTogV2FsbGV0TmFtZSB8IG51bGwpIHtcbiAgICB0aGlzLl9uYW1lLm5leHQod2FsbGV0TmFtZSk7XG4gIH1cblxuICAvLyBDb25uZWN0IHRoZSBhZGFwdGVyIHRvIHRoZSB3YWxsZXRcbiAgY29ubmVjdCgpOiBPYnNlcnZhYmxlPHVua25vd24+IHtcbiAgICByZXR1cm4gY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLmNvbm5lY3RpbmckLFxuICAgICAgdGhpcy5kaXNjb25uZWN0aW5nJCxcbiAgICAgIHRoaXMuY29ubmVjdGVkJCxcbiAgICAgIHRoaXMuX2FkYXB0ZXIkLFxuICAgICAgdGhpcy5fcmVhZHlTdGF0ZSQsXG4gICAgXSkucGlwZShcbiAgICAgIGZpcnN0KCksXG4gICAgICBmaWx0ZXIoXG4gICAgICAgIChbY29ubmVjdGluZywgZGlzY29ubmVjdGluZywgY29ubmVjdGVkXSkgPT5cbiAgICAgICAgICAhY29ubmVjdGVkICYmICFjb25uZWN0aW5nICYmICFkaXNjb25uZWN0aW5nXG4gICAgICApLFxuICAgICAgY29uY2F0TWFwKChbLCAsICwgYWRhcHRlciwgcmVhZHlTdGF0ZV0pID0+IHtcbiAgICAgICAgaWYgKCFhZGFwdGVyKSB7XG4gICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgV2FsbGV0Tm90U2VsZWN0ZWRFcnJvcigpO1xuICAgICAgICAgIHRoaXMuX3NldEVycm9yKGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXG4gICAgICAgICAgIShcbiAgICAgICAgICAgIHJlYWR5U3RhdGUgPT09IFdhbGxldFJlYWR5U3RhdGUuSW5zdGFsbGVkIHx8XG4gICAgICAgICAgICByZWFkeVN0YXRlID09PSBXYWxsZXRSZWFkeVN0YXRlLkxvYWRhYmxlXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICB0aGlzLnNlbGVjdFdhbGxldChudWxsKTtcblxuICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgd2luZG93Lm9wZW4oYWRhcHRlci51cmwsICdfYmxhbmsnKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBXYWxsZXROb3RSZWFkeUVycm9yKCk7XG4gICAgICAgICAgdGhpcy5fc2V0RXJyb3IoZXJyb3IpO1xuICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7IGNvbm5lY3Rpbmc6IHRydWUgfSk7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oZGVmZXIoKCkgPT4gYWRhcHRlci5jb25uZWN0KCkpKS5waXBlKFxuICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdFdhbGxldChudWxsKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycm9yKTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLnBhdGNoU3RhdGUoeyBjb25uZWN0aW5nOiBmYWxzZSB9KSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8vIERpc2Nvbm5lY3QgdGhlIGFkYXB0ZXIgZnJvbSB0aGUgd2FsbGV0XG4gIGRpc2Nvbm5lY3QoKTogT2JzZXJ2YWJsZTx1bmtub3duPiB7XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW3RoaXMuZGlzY29ubmVjdGluZyQsIHRoaXMuX2FkYXB0ZXIkXSkucGlwZShcbiAgICAgIGZpcnN0KCksXG4gICAgICBmaWx0ZXIoKFtkaXNjb25uZWN0aW5nXSkgPT4gIWRpc2Nvbm5lY3RpbmcpLFxuICAgICAgY29uY2F0TWFwKChbLCBhZGFwdGVyXSkgPT4ge1xuICAgICAgICBpZiAoIWFkYXB0ZXIpIHtcbiAgICAgICAgICB0aGlzLnNlbGVjdFdhbGxldChudWxsKTtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBhdGNoU3RhdGUoeyBkaXNjb25uZWN0aW5nOiB0cnVlIH0pO1xuICAgICAgICByZXR1cm4gZnJvbShkZWZlcigoKSA9PiBhZGFwdGVyLmRpc2Nvbm5lY3QoKSkpLnBpcGUoXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0V2FsbGV0KG51bGwpO1xuICAgICAgICAgICAgLy8gUmV0aHJvdyB0aGUgZXJyb3IsIGFuZCBoYW5kbGVFcnJvciB3aWxsIGFsc28gYmUgY2FsbGVkXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnJvcik7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wYXRjaFN0YXRlKHsgZGlzY29ubmVjdGluZzogZmFsc2UgfSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8vIFNlbmQgYSB0cmFuc2FjdGlvbiB1c2luZyB0aGUgcHJvdmlkZWQgY29ubmVjdGlvblxuICBzZW5kVHJhbnNhY3Rpb248VCBleHRlbmRzIFRyYW5zYWN0aW9uIHwgVmVyc2lvbmVkVHJhbnNhY3Rpb24+KFxuICAgIHRyYW5zYWN0aW9uOiBULFxuICAgIGNvbm5lY3Rpb246IENvbm5lY3Rpb24sXG4gICAgb3B0aW9ucz86IFNlbmRUcmFuc2FjdGlvbk9wdGlvbnNcbiAgKTogT2JzZXJ2YWJsZTxUcmFuc2FjdGlvblNpZ25hdHVyZT4ge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFt0aGlzLl9hZGFwdGVyJCwgdGhpcy5jb25uZWN0ZWQkXSkucGlwZShcbiAgICAgIGZpcnN0KCksXG4gICAgICBjb25jYXRNYXAoKFthZGFwdGVyLCBjb25uZWN0ZWRdKSA9PiB7XG4gICAgICAgIGlmICghYWRhcHRlcikge1xuICAgICAgICAgIGNvbnN0IGVycm9yID0gbmV3IFdhbGxldE5vdFNlbGVjdGVkRXJyb3IoKTtcbiAgICAgICAgICB0aGlzLl9zZXRFcnJvcihlcnJvcik7XG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjb25uZWN0ZWQpIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBXYWxsZXROb3RDb25uZWN0ZWRFcnJvcigpO1xuICAgICAgICAgIHRoaXMuX3NldEVycm9yKGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICBkZWZlcigoKSA9PiBhZGFwdGVyLnNlbmRUcmFuc2FjdGlvbih0cmFuc2FjdGlvbiwgY29ubmVjdGlvbiwgb3B0aW9ucykpXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvLyBTaWduIGEgdHJhbnNhY3Rpb24gaWYgdGhlIHdhbGxldCBzdXBwb3J0cyBpdFxuICBzaWduVHJhbnNhY3Rpb248VCBleHRlbmRzIFRyYW5zYWN0aW9uIHwgVmVyc2lvbmVkVHJhbnNhY3Rpb24+KFxuICAgIHRyYW5zYWN0aW9uOiBUXG4gICk6IFJldHVyblR5cGU8U2lnbmVyV2FsbGV0QWRhcHRlclByb3BzWydzaWduVHJhbnNhY3Rpb24nXT4gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgYWRhcHRlciwgY29ubmVjdGVkIH0gPSB0aGlzLmdldCgpO1xuXG4gICAgcmV0dXJuIGFkYXB0ZXIgJiYgJ3NpZ25UcmFuc2FjdGlvbicgaW4gYWRhcHRlclxuICAgICAgPyBzaWduVHJhbnNhY3Rpb24oYWRhcHRlciwgY29ubmVjdGVkLCAoZXJyb3IpID0+IHRoaXMuX3NldEVycm9yKGVycm9yKSkoXG4gICAgICAgICAgdHJhbnNhY3Rpb25cbiAgICAgICAgKVxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICAvLyBTaWduIG11bHRpcGxlIHRyYW5zYWN0aW9ucyBpZiB0aGUgd2FsbGV0IHN1cHBvcnRzIGl0XG4gIHNpZ25BbGxUcmFuc2FjdGlvbnM8VCBleHRlbmRzIFRyYW5zYWN0aW9uIHwgVmVyc2lvbmVkVHJhbnNhY3Rpb24+KFxuICAgIHRyYW5zYWN0aW9uczogVFtdXG4gICk6IFJldHVyblR5cGU8U2lnbmVyV2FsbGV0QWRhcHRlclByb3BzWydzaWduQWxsVHJhbnNhY3Rpb25zJ10+IHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCB7IGFkYXB0ZXIsIGNvbm5lY3RlZCB9ID0gdGhpcy5nZXQoKTtcblxuICAgIHJldHVybiBhZGFwdGVyICYmICdzaWduQWxsVHJhbnNhY3Rpb25zJyBpbiBhZGFwdGVyXG4gICAgICA/IHNpZ25BbGxUcmFuc2FjdGlvbnMoYWRhcHRlciwgY29ubmVjdGVkLCAoZXJyb3IpID0+XG4gICAgICAgICAgdGhpcy5fc2V0RXJyb3IoZXJyb3IpXG4gICAgICAgICkodHJhbnNhY3Rpb25zKVxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICAvLyBTaWduIGFuIGFyYml0cmFyeSBtZXNzYWdlIGlmIHRoZSB3YWxsZXQgc3VwcG9ydHMgaXRcbiAgc2lnbk1lc3NhZ2UobWVzc2FnZTogVWludDhBcnJheSk6IE9ic2VydmFibGU8VWludDhBcnJheT4gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgYWRhcHRlciwgY29ubmVjdGVkIH0gPSB0aGlzLmdldCgpO1xuXG4gICAgcmV0dXJuIGFkYXB0ZXIgJiYgJ3NpZ25NZXNzYWdlJyBpbiBhZGFwdGVyXG4gICAgICA/IHNpZ25NZXNzYWdlKGFkYXB0ZXIsIGNvbm5lY3RlZCwgKGVycm9yKSA9PiB0aGlzLl9zZXRFcnJvcihlcnJvcikpKFxuICAgICAgICAgIG1lc3NhZ2VcbiAgICAgICAgKVxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cbn1cbiJdfQ==